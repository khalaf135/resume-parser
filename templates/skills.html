<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skills - Jadeer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-icon">üìã</span>
                    <span class="logo-text">Jadeer</span>
                </div>
            </div>
            <nav class="sidebar-nav">
                <a href="/dashboard" class="nav-item">
                    <span class="nav-icon">üë§</span>
                    <span>Profile</span>
                </a>
                <a href="/skills" class="nav-item active">
                    <span class="nav-icon">‚ö°</span>
                    <span>Skills</span>
                </a>
                <a href="/certificates" class="nav-item">
                    <span class="nav-icon">üìú</span>
                    <span>Certificates</span>
                </a>
                <a href="/recommendations" class="nav-item">
                    <span class="nav-icon">üí°</span>
                    <span>Get Recommendations</span>
                </a>
                <a href="/cvs" class="nav-item">
                    <span class="nav-icon">üìÑ</span>
                    <span>My CVs</span>
                </a>
                <a href="#" class="nav-item disabled">
                    <span class="nav-icon">üí¨</span>
                    <span>Chats</span>
                    <span class="coming-soon">Soon</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <div class="page-title">
                    <h1>Skills Management</h1>
                    <p>Add and verify your skills to stand out to employers</p>
                </div>
                <div class="top-bar-actions">
                    <button class="btn-primary" onclick="openAddModal()">+ Add Skill</button>
                    <button class="btn-secondary" onclick="logout()">Logout</button>
                </div>
            </header>

            <div class="skills-content">
                <!-- Soft Skills -->
                <div class="skills-section">
                    <h2>üß† Soft Skills</h2>
                    <div class="skills-grid" id="softSkillsGrid">
                        <p class="empty-state">No soft skills added yet</p>
                    </div>
                </div>

                <!-- Technical Skills -->
                <div class="skills-section">
                    <h2>üíª Technical Skills</h2>
                    <div class="skills-grid" id="technicalSkillsGrid">
                        <p class="empty-state">No technical skills added yet</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Skill Modal -->
    <div class="modal-overlay" id="addSkillModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add New Skill</h3>
                <button class="modal-close" onclick="closeAddModal()">√ó</button>
            </div>
            <form onsubmit="addSkill(event)">
                <div class="form-group">
                    <label for="skillName">Skill Name *</label>
                    <input type="text" id="skillName" placeholder="e.g., Python, Communication" required>
                </div>
                <div class="form-group">
                    <label for="skillType">Skill Type *</label>
                    <select id="skillType" required>
                        <option value="technical">Technical</option>
                        <option value="soft">Soft Skill</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeAddModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Add Skill</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assessment Modal -->
    <div class="modal-overlay" id="assessmentModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h3 id="assessmentTitle">Skill Assessment</h3>
                <button class="modal-close" onclick="closeAssessmentModal()">√ó</button>
            </div>
            <div id="assessmentContent">
                <!-- Questions or results will be loaded here -->
            </div>
        </div>
    </div>

    <script src="/static/app.js"></script>
    <script>
        let currentSkills = [];
        let assessmentSession = null;
        let currentQuestionIndex = 0;
        let answers = {};

        // Check authentication
        if (!localStorage.getItem('access_token')) {
            window.location.href = '/login';
        }

        // Load skills
        async function loadSkills() {
            try {
                const response = await fetch('/api/skills', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();

                if (data.success) {
                    currentSkills = data.skills;
                    renderSkills();
                }
            } catch (error) {
                console.error('Error loading skills:', error);
            }
        }

        function renderSkills() {
            const softSkills = currentSkills.filter(s => s.skill_type === 'soft');
            const techSkills = currentSkills.filter(s => s.skill_type === 'technical');

            document.getElementById('softSkillsGrid').innerHTML = softSkills.length ?
                softSkills.map(skill => renderSkillCard(skill)).join('') :
                '<p class="empty-state">No soft skills added yet</p>';

            document.getElementById('technicalSkillsGrid').innerHTML = techSkills.length ?
                techSkills.map(skill => renderSkillCard(skill)).join('') :
                '<p class="empty-state">No technical skills added yet</p>';
        }

        function renderSkillCard(skill) {
            const verified = skill.is_verified;
            const score = skill.score || 0;

            return `
                <div class="skill-modern-card ${verified ? 'verified' : ''}">
                    <div class="skill-card-body">
                        <div class="skill-info-header">
                            <span class="skill-badge-icon">${skill.skill_type === 'technical' ? 'üíª' : 'üß†'}</span>
                            <div class="skill-name-wrap">
                                <h3 class="skill-name">${skill.skill_name}</h3>
                                ${verified ? '<span class="verified-tag">Verified</span>' : '<span class="pending-tag">Unverified</span>'}
                            </div>
                        </div>
                        
                        <div class="skill-stats">
                            <div class="score-container">
                                <div class="score-header">
                                    <span>Proficiency</span>
                                    <span class="score-pct">${score}%</span>
                                </div>
                                <div class="score-track">
                                    <div class="score-thumb" style="width: ${score}%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="skill-card-actions">
                            <button class="btn btn-primary btn-sm" onclick="startAssessment('${skill.id}', '${skill.skill_name}')">
                                ${verified ? 'Retake' : 'Verify Skill'}
                            </button>
                            <button class="btn btn-icon-only text-danger" onclick="deleteSkill('${skill.id}')" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function openAddModal() {
            document.getElementById('addSkillModal').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addSkillModal').classList.remove('active');
            document.getElementById('skillName').value = '';
        }

        async function addSkill(e) {
            e.preventDefault();

            const skillName = document.getElementById('skillName').value;
            const skillType = document.getElementById('skillType').value;

            try {
                const response = await fetch('/api/skills', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({ skill_name: skillName, skill_type: skillType })
                });

                const data = await response.json();
                if (data.success) {
                    closeAddModal();
                    loadSkills();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Network error');
            }
        }

        async function deleteSkill(skillId) {
            if (!confirm('Are you sure you want to delete this skill?')) return;

            try {
                const response = await fetch(`/api/skills/${skillId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    loadSkills();
                }
            } catch (error) {
                alert('Error deleting skill');
            }
        }

        async function startAssessment(skillId, skillName) {
            document.getElementById('assessmentTitle').textContent = `${skillName} Assessment`;
            document.getElementById('assessmentContent').innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>‚è≥ AI is generating your custom assessment...</p>
                    <p class="subtext">This can take up to 30 seconds. Please don't close this window.</p>
                </div>
            `;
            document.getElementById('assessmentModal').classList.add('active');

            try {
                const response = await fetch(`/api/skills/${skillId}/assess`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                const data = await response.json();
                if (data.success) {
                    assessmentSession = data.session_id;
                    currentQuestionIndex = 0;
                    answers = {};
                    renderQuestion(data.questions, 0);
                } else {
                    document.getElementById('assessmentContent').innerHTML =
                        `<p class="error">Error: ${data.error}</p>`;
                }
            } catch (error) {
                document.getElementById('assessmentContent').innerHTML =
                    '<p class="error">Network error. Please try again.</p>';
            }
        }

        function renderQuestion(questions, index) {
            const question = questions[index];
            const total = questions.length;

            let optionsHtml = '';
            if (question.type === 'multiple_choice') {
                optionsHtml = question.options.map((opt, i) => `
                    <label class="quiz-option">
                        <input type="radio" name="answer" value="${opt}">
                        <span>${opt}</span>
                    </label>
                `).join('');
            } else {
                optionsHtml = `
                    <label class="quiz-option">
                        <input type="radio" name="answer" value="true">
                        <span>True</span>
                    </label>
                    <label class="quiz-option">
                        <input type="radio" name="answer" value="false">
                        <span>False</span>
                    </label>
                `;
            }

            document.getElementById('assessmentContent').innerHTML = `
                <div class="quiz-progress">
                    <span>Question ${index + 1} of ${total}</span>
                    <div class="progress-bar-horizontal">
                        <div class="progress-fill-horizontal" style="width: ${((index + 1) / total) * 100}%"></div>
                    </div>
                </div>
                <div class="quiz-question">
                    <pre>${question.question}</pre>
                </div>
                <div class="quiz-options">
                    ${optionsHtml}
                </div>
                <div class="quiz-actions">
                    ${index > 0 ? `<button class="btn-secondary" onclick="prevQuestion(${index}, ${JSON.stringify(questions).replace(/"/g, '&quot;')})">Previous</button>` : '<div></div>'}
                    ${index < total - 1 ?
                    `<button class="btn-primary" onclick="nextQuestion(${index}, ${JSON.stringify(questions).replace(/"/g, '&quot;')})">Next</button>` :
                    `<button class="btn-primary" onclick="submitAssessment()">Submit</button>`
                }
                </div>
            `;

            // Restore previous answer if exists
            if (answers[question.id]) {
                const radio = document.querySelector(`input[value="${answers[question.id]}"]`);
                if (radio) radio.checked = true;
            }
        }

        function saveCurrentAnswer(questionId) {
            const selected = document.querySelector('input[name="answer"]:checked');
            if (selected) {
                answers[questionId] = selected.value;
            }
        }

        function nextQuestion(currentIndex, questions) {
            saveCurrentAnswer(questions[currentIndex].id);
            renderQuestion(questions, currentIndex + 1);
        }

        function prevQuestion(currentIndex, questions) {
            saveCurrentAnswer(questions[currentIndex].id);
            renderQuestion(questions, currentIndex - 1);
        }

        async function submitAssessment() {
            // Save last answer
            const selected = document.querySelector('input[name="answer"]:checked');
            if (selected) {
                const lastQId = Object.keys(answers).length + 1;
                answers[lastQId] = selected.value;
            }

            document.getElementById('assessmentContent').innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>üß† AI is evaluating your answers...</p>
                </div>
            `;

            try {
                const response = await fetch('/api/skills/evaluate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        session_id: assessmentSession,
                        answers: answers
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showResults(data);
                } else {
                    document.getElementById('assessmentContent').innerHTML =
                        `<p class="error">Error: ${data.error}</p>`;
                }
            } catch (error) {
                document.getElementById('assessmentContent').innerHTML =
                    '<p class="error">Network error. Please try again.</p>';
            }
        }

        function showResults(data) {
            const passed = data.is_verified;

            document.getElementById('assessmentContent').innerHTML = `
                <div class="assessment-results ${passed ? 'passed' : 'failed'}">
                    <div class="result-icon">${passed ? 'üéâ' : 'üìö'}</div>
                    <h2>${passed ? 'Congratulations!' : 'Keep Practicing!'}</h2>
                    <div class="result-score">
                        <span class="score-big">${data.score}%</span>
                        <span class="score-detail">${data.correct}/${data.total} correct</span>
                    </div>
                    <p class="result-message">
                        ${passed ?
                    'Your skill is now verified! Employers will see this badge.' :
                    'You need 70% or higher to verify this skill. Review the feedback below and try again.'}
                    </p>
                    <div class="result-details">
                        ${data.results.map(r => `
                            <div class="result-item ${r.is_correct ? 'correct' : 'incorrect'}">
                                <span class="result-status">${r.is_correct ? '‚úì' : '‚úó'}</span>
                                <div class="result-question">
                                    <pre>${r.question}</pre>
                                    ${!r.is_correct ? `<p class="explanation">Correct answer: ${r.correct_answer}. ${r.explanation}</p>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn-primary" onclick="closeAssessmentModal(); loadSkills();">Done</button>
                </div>
            `;
        }

        function closeAssessmentModal() {
            document.getElementById('assessmentModal').classList.remove('active');
        }

        loadSkills();
    </script>
</body>

</html>